name: Pull Request

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check if CHANGELOG.md was updated
  changelog:
    name: Check CHANGELOG.md
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CHANGELOG.md was updated
        run: |
          # Get the list of changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if CHANGELOG.md is in the list
          if ! echo "$CHANGED_FILES" | grep -q "^CHANGELOG.md$"; then
            echo "::warning::CHANGELOG.md was not updated. Please add your changes to the [Unreleased] section."
            echo ""
            echo "If this is a documentation-only change or doesn't require a changelog entry,"
            echo "you can ignore this warning. Otherwise, please update CHANGELOG.md following"
            echo "the Keep a Changelog format: https://keepachangelog.com/en/1.1.0/"
            echo ""
            echo "Example:"
            echo "## [Unreleased]"
            echo ""
            echo "### Added"
            echo "- Your new feature"
            echo ""
            echo "### Fixed"
            echo "- Your bug fix"
          else
            echo "âœ“ CHANGELOG.md was updated"
          fi

  # Run all checks using make check
  check:
    name: Run make check
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Download dependencies
        run: go mod download

      - name: Run make check
        run: make check

      - name: Check for uncommitted changes
        id: auto_fixes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected after make check:"
            git status --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit and push automatic fixes
        if: steps.auto_fixes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Apply automatic fixes (formatting, go.mod/go.sum)

          This commit was automatically generated by the CI workflow.
          Changes include:
          - Code formatting via gofmt
          - Module dependency updates via go mod tidy

          These changes were applied by running 'make check'."
          git push

      - name: Comment on PR about automatic fixes
        if: steps.auto_fixes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;

            // Get all commits in the PR to find commit authors
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: issue_number,
            });

            // Extract unique commit authors (excluding bots)
            const authorLogins = new Set();
            commits.data.forEach(commit => {
              if (commit.author && commit.author.login && !commit.author.login.includes('[bot]')) {
                authorLogins.add(commit.author.login);
              }
              // Also check committer if different from author
              if (commit.committer && commit.committer.login &&
                  !commit.committer.login.includes('[bot]') &&
                  commit.committer.login !== commit.author?.login) {
                authorLogins.add(commit.committer.login);
              }
            });

            // Build mentions string
            const mentions = Array.from(authorLogins).map(login => `@${login}`).join(' ');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `ðŸ‘· **Automatic fixes applied**

              ${mentions} The CI workflow has automatically fixed some issues in your PR:

              - âœ¨ Code formatting (via \`gofmt\`)
              - ðŸ“¦ Module dependencies (via \`go mod tidy\`)

              The changes have been pushed to your branch. Please pull the latest changes:

              \`\`\`bash
              git pull origin ${{ github.head_ref }}
              \`\`\`

              These fixes ensure code consistency and are applied automatically to reduce manual toil.`
            });

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Build binaries for all platforms
  build:
    name: Build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          make build
          ls -lh bin/

  # All checks passed
  all-checks:
    name: All Checks Passed
    needs: [check, build]
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: echo "All checks passed successfully!"
