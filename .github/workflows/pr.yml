name: Pull Request

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pull-requests: read

jobs:
  # Check if CHANGELOG.md was updated
  changelog:
    name: Check CHANGELOG.md
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if CHANGELOG.md was updated
        run: |
          # Get the list of changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if CHANGELOG.md is in the list
          if ! echo "$CHANGED_FILES" | grep -q "^CHANGELOG.md$"; then
            echo "::warning::CHANGELOG.md was not updated. Please add your changes to the [Unreleased] section."
            echo ""
            echo "If this is a documentation-only change or doesn't require a changelog entry,"
            echo "you can ignore this warning. Otherwise, please update CHANGELOG.md following"
            echo "the Keep a Changelog format: https://keepachangelog.com/en/1.1.0/"
            echo ""
            echo "Example:"
            echo "## [Unreleased]"
            echo ""
            echo "### Added"
            echo "- Your new feature"
            echo ""
            echo "### Fixed"
            echo "- Your bug fix"
          else
            echo "âœ“ CHANGELOG.md was updated"
          fi

  # Run all checks using make check
  check:
    name: Run make check
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Download dependencies
        run: go mod download

      - name: Run make check
        run: make check

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Build binaries for all platforms
  build:
    name: Build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          make build
          ls -lh bin/

      - name: Test binary
        if: matrix.os == 'ubuntu-latest' && matrix.goarch == 'amd64'
        run: |
          ./bin/llima-box --help

  # All checks passed
  all-checks:
    name: All Checks Passed
    needs: [check, build]
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: echo "All checks passed successfully!"
