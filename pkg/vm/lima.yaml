images:
# x86_64 / AMD64 architecture
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
  arch: "x86_64"
# ARM64 / aarch64 architecture (Apple Silicon)
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
  arch: "aarch64"

cpus: 4
memory: "8GiB"
disk: "100GiB"

mounts:
- location: "~"
  writable: true

ssh:
  localPort: 60022
  loadDotSSHPubKeys: true
  forwardAgent: true

provision:
# Install required packages
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    export DEBIAN_FRONTEND=noninteractive

    apt-get update
    apt-get install -y build-essential curl git

# Create namespace setup script
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    cat > /usr/local/bin/create-namespace.sh << 'SCRIPT_EOF'
    #!/bin/bash
    set -e

    ENV_NAME="$1"
    PROJECT_PATH="$2"
    PID_FILE="/home/$ENV_NAME/namespace.pid"

    if [ -z "$ENV_NAME" ] || [ -z "$PROJECT_PATH" ]; then
        echo "Usage: $0 <env_name> <project_path>"
        exit 1
    fi

    echo "Creating persistent namespace for $ENV_NAME at $PROJECT_PATH"

    # Start namespace process in background
    # Redirect stdout/stderr to /dev/null to prevent SSH session from waiting
    unshare --mount --propagation private bash -c '
        # Make all mounts private to avoid propagation
        mount --make-rprivate /

        # Create isolated root
        mkdir -p /tmp/isolated-root

        # Mount system directories (read-only)
        for dir in bin sbin lib lib64 usr etc; do
            if [ -d "/$dir" ]; then
                mkdir -p "/tmp/isolated-root/$dir"
                mount --bind "/$dir" "/tmp/isolated-root/$dir"
                mount -o remount,bind,ro "/tmp/isolated-root/$dir"
            fi
        done

        # Mount runtime directories
        mkdir -p /tmp/isolated-root/{tmp,var,proc,sys,dev}
        mount --bind /tmp /tmp/isolated-root/tmp
        mount --bind /var /tmp/isolated-root/var
        mount --bind /proc /tmp/isolated-root/proc
        mount --bind /sys /tmp/isolated-root/sys
        mount --bind /dev /tmp/isolated-root/dev

        # Mount devpts for PTY support    
        mount -t devpts devpts /tmp/isolated-root/dev/pts -o newinstance,ptmxmode=0666

        # Create project path structure
        project_path="'"$PROJECT_PATH"'"
        parent_path="$(dirname "$project_path")"
        mkdir -p "/tmp/isolated-root$parent_path"
        mkdir -p "/tmp/isolated-root$project_path"
        mount --bind "$project_path" "/tmp/isolated-root$project_path"

        # Mount user home
        mkdir -p "/tmp/isolated-root/home/'"$ENV_NAME"'"
        mount --bind "/home/'"$ENV_NAME"'" "/tmp/isolated-root/home/'"$ENV_NAME"'"

        # Run sleep to keep namespace alive
        chroot /tmp/isolated-root sleep infinity
    ' >/dev/null 2>&1 &
    UNSHARE_PID=$!

    echo "Namespace process started with PID: $UNSHARE_PID"

    # Wait for namespace to be created
    sleep 1

    # Verify the namespace exists
    if [ ! -f "/proc/$UNSHARE_PID/ns/mnt" ]; then
        echo "Error: Namespace not found at /proc/$UNSHARE_PID/ns/mnt" >&2
        kill $UNSHARE_PID 2>/dev/null || true
        exit 1
    fi

    # Verify background process is still running
    if ! kill -0 $UNSHARE_PID 2>/dev/null; then
        echo "Error: Namespace process died unexpectedly" >&2
        exit 1
    fi

    # Store the PID for later use
    echo "$UNSHARE_PID" > "$PID_FILE"
    chown "$ENV_NAME:$ENV_NAME" "$PID_FILE"

    echo "Namespace created successfully (PID: $UNSHARE_PID, PID file: $PID_FILE)"
    SCRIPT_EOF

    chmod +x /usr/local/bin/create-namespace.sh

# Create sandbox entry script
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    cat > /usr/local/bin/sandbox.sh << 'SCRIPT_EOF'
    #!/bin/bash
    set -e

    ENV_NAME="$1"
    PROJECT_PATH="$2"
    shift 2

    PID_FILE="/home/$ENV_NAME/namespace.pid"

    if [ -z "$ENV_NAME" ] || [ -z "$PROJECT_PATH" ]; then
        echo "Usage: $0 <env_name> <project_path> [command...]"
        exit 1
    fi

    if [ $# -eq 0 ]; then
        set -- bash
    fi

    if [ ! -f "$PID_FILE" ]; then
        echo "Error: Namespace PID file $PID_FILE not found"
        exit 1
    fi

    # Read the PID
    NS_PID=$(cat "$PID_FILE")

    # Verify the process is still running
    if ! kill -0 "$NS_PID" 2>/dev/null; then
        echo "Error: Namespace process (PID $NS_PID) is not running"
        exit 1
    fi

    # Enter the namespace using the PID and switch to the environment user
    # Note: We use 'su -l' to get a login shell with the user's environment
    nsenter --mount="/proc/$NS_PID/ns/mnt" su -l "$ENV_NAME" -c "cd '$PROJECT_PATH' && exec \"\$@\"" -- "$@"
    SCRIPT_EOF

    chmod +x /usr/local/bin/sandbox.sh

# Configure sudo permissions
- mode: user
  script: |
    #!/bin/bash
    set -eux -o pipefail

    echo "$USER ALL=(ALL) NOPASSWD: /usr/sbin/useradd, /usr/sbin/userdel, /bin/mkdir, /bin/chown, /usr/local/bin/create-namespace.sh, /usr/local/bin/sandbox.sh, /usr/bin/pkill, /usr/bin/nsenter, /usr/bin/findmnt, /usr/bin/mount, /usr/bin/mountpoint, /usr/bin/su" | sudo tee /etc/sudoers.d/lima-environments
    sudo chmod 440 /etc/sudoers.d/lima-environments

probes:
- mode: readiness
  description: "Environment management scripts installed"
  script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! [ -x /usr/local/bin/create-namespace.sh ] || ! [ -x /usr/local/bin/sandbox.sh ]; then
      echo >&2 "Environment scripts not installed"
      exit 1
    fi
